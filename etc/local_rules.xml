<!--
  Local rules for enhanced security detection
  File: /var/monitoring-agent/etc/local_rules.xml
-->

<group name="local,syslog,">
  
  <!-- Enhanced Nmap Detection -->
  <rule id="100001" level="8">
    <if_group>command</if_group>
    <match>nmap|masscan|zenmap</match>
    <description>Network scanning tool detected in process list</description>
    <group>recon,scanning,</group>
  </rule>
  
  <!-- SSH Brute Force Enhanced -->
  <rule id="100002" level="10">
    <if_group>authentication_failed</if_group>
    <match>ssh|sshd</match>
    <description>SSH authentication failure detected</description>
    <group>authentication_failed,ssh,</group>
  </rule>
  
  <!-- Netcat/Reverse Shell Detection -->
  <rule id="100003" level="12">
    <if_group>command</if_group>
    <match>nc -l|netcat -l|/bin/sh|/bin/bash</match>
    <regex>\d+\.\d+\.\d+\.\d+</regex>
    <description>Possible reverse shell or netcat listener detected</description>
    <group>intrusion,reverse_shell,</group>
  </rule>
  
  <!-- Multiple Connection Attempts -->
  <rule id="100004" level="6">
    <if_group>command</if_group>
    <match>LISTEN</match>
    <regex>:\d{4,5}\s</regex>
    <description>New network service listening on high port</description>
    <group>network,listening_ports,</group>
  </rule>
  
  <!-- Enhanced Sudo Detection -->
  <rule id="100005" level="4">
    <if_group>sudo</if_group>
    <match>COMMAND=</match>
    <description>Sudo command execution detected</description>
    <group>privilege_escalation,sudo,</group>
  </rule>
  
  <!-- File Access in Sensitive Directories -->
  <rule id="100006" level="7">
    <if_group>command</if_group>
    <match>/etc/passwd|/etc/shadow|/etc/sudoers</match>
    <description>Access to sensitive system files detected</description>
    <group>privilege_escalation,sensitive_files,</group>
  </rule>
  
  <!-- Log Injection Detection -->
  <rule id="100007" level="10">
    <match>SECURITY_TEST|WAZUH_TEST</match>
    <description>Security test injection detected in logs</description>
    <group>log_injection,testing,</group>
  </rule>

</group>

<!-- Frequency-based rules for enhanced detection -->
<group name="local,frequency,">
  
  <!-- Multiple failed connections -->
  <rule id="100101" level="10" frequency="5" timeframe="120">
    <if_matched_sid>100002</if_matched_sid>
    <same_source_ip />
    <description>Multiple SSH authentication failures from same IP</description>
    <group>brute_force,ssh,</group>
  </rule>
  
  <!-- Multiple sudo commands -->
  <rule id="100102" level="8" frequency="3" timeframe="300">
    <if_matched_sid>100005</if_matched_sid>
    <same_user />
    <description>Multiple sudo commands by same user in short time</description>
    <group>privilege_escalation,suspicious_activity,</group>
  </rule>

</group>
