# Monitoring Agent - Complete Installation & Management Guide

## üìñ Table of Contents

- [Overview](#overview)
- [Quick Start](#quick-start)
- [System Requirements](#system-requirements)
- [Installation](#installation)
- [Monitoring Manager Setup with Docker](#monitoring-manager-setup-with-docker)
- [Agent Enrollment](#agent-enrollment)
- [Agent Management](#agent-management)
- [Troubleshooting](#troubleshooting)
- [Advanced Configuration](#advanced-configuration)

---

## Overview

The **Monitoring Agent** is a professional security monitoring solution that provides:

- üè† **Self-Contained**: Everything works within a single directory
- üöÄ **Auto-Setup**: Automatic initialization and configuration
- üîê **Interactive Enrollment**: Guided enrollment with validation
- üìù **Auto-Configuration**: Configuration files updated automatically
- üê≥ **Docker Ready**: Works seamlessly with containerized Monitoring managers

---

## Quick Start

### 1. Extract and Setup
```bash
# Extract the monitoring agent
tar -xzf monitoring-agent.tar.gz
cd monitoring-agent

# Make script executable
chmod +x monitoring-agent-control.sh
```

### 2. Enroll with Manager
```bash
# Interactive enrollment (will prompt for client key)
./monitoring-agent-control.sh enroll <MANAGER_IP>
```

### 3. Start Agent
```bash
# Start with auto-setup
./monitoring-agent-control.sh start
```

### 4. Verify Connection
```bash
# Test connectivity
./monitoring-agent-control.sh test-connection
./monitoring-agent-control.sh status
```

---

## System Requirements

### Linux Requirements
- **OS**: Ubuntu 18.04+, CentOS 7+, Debian 9+, RHEL 7+
- **Memory**: 512MB RAM minimum, 1GB+ recommended
- **Storage**: 1GB free space minimum, 5GB+ recommended
- **Network**: Outbound TCP port 1514 to manager
- **Tools**: bash, sed, awk, nc (netcat)

### Windows Requirements
- **OS**: Windows Server 2016+, Windows 10+
- **PowerShell**: Version 5.1 or higher
- **Memory**: 1GB RAM minimum, 2GB+ recommended
- **Storage**: 2GB free space minimum, 5GB+ recommended
- **Network**: Outbound TCP port 1514 to manager

---

## Installation

### Method 1: Self-Contained Directory (Recommended)

**No system-wide installation required!**

#### Linux
```bash
# Download and extract
wget https://releases.monitoring-solutions.com/monitoring-agent-linux.tar.gz
tar -xzf monitoring-agent-linux.tar.gz
cd monitoring-agent

# Ready to use
./monitoring-agent-control.sh --help
```

#### Windows
```powershell
# Download and extract
Invoke-WebRequest -Uri "https://releases.monitoring-solutions.com/monitoring-agent-windows.zip" -OutFile "monitoring-agent.zip"
Expand-Archive monitoring-agent.zip
cd monitoring-agent

# Ready to use
.\monitoring-agent-control.ps1 -Help
```

---

## Monitoring Manager Setup with Docker

### Prerequisites
```bash
# Install Docker and Docker Compose
sudo apt update
sudo apt install docker.io docker-compose

# Start Docker service
sudo systemctl start docker
sudo systemctl enable docker
```

### Method 1: Single Node Docker Setup

```bash
# Create Wazuh directory
mkdir wazuh-docker && cd wazuh-docker

# Download docker-compose file
curl -so docker-compose.yml https://packages.wazuh.com/4.12/docker/docker-compose.yml

# Start Monitoring manager
sudo docker-compose up -d
```

### Method 2: Quick Single Container

```bash
# Run Monitoring manager in single container
sudo docker run -d \
  --name monitoring-manager \
  -p 1514:1514/tcp \
  -p 1515:1515 \
  -p 514:514/udp \
  -p 55000:55000 \
  -e INDEXER_URL=https://wazuh.indexer:9200 \
  -e INDEXER_USERNAME=admin \
  -e INDEXER_PASSWORD=SecretPassword \
  -e FILEBEAT_SSL_VERIFICATION_MODE=full \
  wazuh/monitoring-manager:4.12.0
```

### Docker Manager Commands

```bash
# Check manager status
sudo docker ps | grep wazuh
### Viewing Manager Alerts (Docker)

To view alerts generated by the Monitoring manager inside the Docker container, you can use several approaches depending on whether you want to see raw alerts, follow them in real time, or query the manager API from inside the container.

- View recent alerts from the Wazuh log files inside the container (plain text):
  sudo docker exec -it monitoring-manager tail -n 200 /var/ossec/logs/alerts/alerts.log

- Follow alerts in real time:
  sudo docker exec -it monitoring-manager tail -n 100 -f /var/ossec/logs/alerts/alerts.log

- Pretty-print the last 50 alerts (if JSON output is available) using jq inside the container:
  sudo docker exec -it monitoring-manager bash -lc "tail -n 200 /var/ossec/logs/alerts/alerts.json 2>/dev/null | jq '.' | tail -n 50"

- Query the Wazuh API from inside the container (requires API service enabled):
  sudo docker exec -it monitoring-manager bash -lc "curl -s -u <user>:<pass> -k https://localhost:55000/alerts | jq '.'"

- Inspect the alerts directory directly (list files and sizes):
  sudo docker exec -it monitoring-manager ls -lh /var/ossec/logs/alerts/

Notes:
- Replace `monitoring-manager` with your container name if different.
- If your manager exposes ports and the API is reachable from the host, you can run the `curl` command directly from the host using the mapped port (e.g., `https://localhost:55000`).
- Not all Wazuh setups write JSON-formatted alerts to `alerts.json`; the default is `alerts.log`. Use the `ls` command above to check available files.

# View manager logs
sudo docker logs monitoring-manager

# Get manager IP (for agent enrollment)
sudo docker inspect monitoring-manager | grep IPAddress

# Access manager shell
sudo docker exec -it monitoring-manager /bin/bash

# Manage agents from Docker
sudo docker exec -it monitoring-manager /var/ossec/bin/manage_agents

# To see the List of Active Agents connected to the Manager
sudo docker exec -it monitoring-manager /var/ossec/bin/agent_control -l

# Stop manager
sudo docker stop monitoring-manager

# Start manager
sudo docker start monitoring-manager

# Remove manager (data will be lost)
sudo docker rm -f monitoring-manager
```

### Get Manager IP for Agent Enrollment

```bash
# Method 1: Docker inspect
MANAGER_IP=$(sudo docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' monitoring-manager)
echo "Manager IP: $MANAGER_IP"

# Method 2: Check all networks
sudo docker network ls
sudo docker network inspect bridge | grep -A 3 wazuh

# Method 3: Use localhost if port forwarding
MANAGER_IP="127.0.0.1"  # If using -p 1514:1514
```

---

## Agent Enrollment

**Important**: The monitoring agent uses **user-specified agent names** instead of system hostnames. This ensures consistent agent identification regardless of the underlying system hostname.

### Step 1: Get Client Key from Manager

#### Docker Manager
```bash
# Access manager container
sudo docker exec -it monitoring-manager /bin/bash

# Inside container, manage agents
/var/ossec/bin/manage_agents

# Follow prompts:
# A) Add agent
# Enter agent name (e.g., myserver, webserver, database-01)
# ‚ö†Ô∏è  IMPORTANT: Use descriptive names, NOT system hostnames
# Enter agent IP (use 'any' for flexibility)
# Get agent ID and key

# E) Extract key for the agent
# Copy the complete base64 key

# L) List agents (to verify creation)
```

#### Physical Manager
```bash
# On manager server
sudo /var/ossec/bin/manage_agents

# Follow same process as above
```

### Step 2: Enroll Agent (Interactive)

```bash
# Start enrollment process
./monitoring-agent-control.sh enroll <MANAGER_IP>

# Example with Docker manager
./monitoring-agent-control.sh enroll 172.17.0.2
```

**Interactive Process:**
```
====================================================
Client Key Required
====================================================
Please provide the client key obtained from the Monitoring manager.
You can get this key by running on the manager:
  sudo /var/ossec/bin/manage_agents -l

The key should be in format:
  001 agent-name 192.168.1.100 abc123...def456

Enter the complete client key line: _
```

**Important Notes:**
- ‚úÖ **Agent Name Override**: The enrollment process uses the manager-configured agent name, NOT the system hostname
- ‚úÖ **Auto-Enrollment Disabled**: Prevents automatic registration with hostname to ensure consistent naming
- ‚úÖ **Manual Key Required**: Only pre-configured agent keys are accepted (no auto-generation)

**Paste your key:** `001 myserver ANY abcd1234567890...`

The enrollment will:
- ‚úÖ Validate key format
- ‚úÖ Update `ossec.conf` with manager IP
- ‚úÖ Create `client.keys` with correct IP
- ‚úÖ Configure enrollment settings to disable auto-enrollment
- ‚úÖ Offer to start agent immediately

### Enrollment Configuration

The agent automatically configures the following settings in `etc/ossec.conf` to ensure proper manual enrollment:

```xml
<client>
  <server>
    <address>MANAGER_IP</address>
    <port>1514</port>
    <protocol>tcp</protocol>
  </server>
  <enrollment>
    <enabled>no</enabled>
  </enrollment>
  <!-- Other client settings... -->
</client>
```

**Key Benefits:**
- üö´ **No Auto-Enrollment**: Prevents automatic registration with system hostname
- üè∑Ô∏è **Manual Agent Names**: Uses descriptive names configured on manager
- üîê **Key-Based Only**: Only accepts pre-configured authentication keys

### Step 3: Verification

```bash
# Check enrollment
cat etc/client.keys
cat etc/ossec.conf | grep -A3 server

# Test connectivity
./monitoring-agent-control.sh test-connection
```

---

## Agent Management

### Essential Commands

```bash
# Check status
./monitoring-agent-control.sh status

# Start agent (with auto-setup)
./monitoring-agent-control.sh start

# Stop agent
./monitoring-agent-control.sh stop

# Restart agent
./monitoring-agent-control.sh restart

# View logs
./monitoring-agent-control.sh logs [lines] [follow]

# Examples:
./monitoring-agent-control.sh logs 100        # Last 100 lines
./monitoring-agent-control.sh logs 50 true    # Follow mode
```

### Health and Connectivity

```bash
# Health check
./monitoring-agent-control.sh health

# Test connectivity to manager
./monitoring-agent-control.sh test-connection

# Show detailed help
./monitoring-agent-control.sh --help
```

### Configuration Management

```bash
# Backup configuration
./monitoring-agent-control.sh backup

# Restore from backup
./monitoring-agent-control.sh restore <backup_path>

# Configure firewall
./monitoring-agent-control.sh configure-firewall <manager_ip>
```

---

## Troubleshooting

### Common Issues

#### 1. **Agent Naming Issues**

**Problem**: Agent appears with system hostname instead of configured name
```bash
# On manager, agent shows as system hostname (e.g., "ubuntu-server")
# Instead of configured name (e.g., "web-server-01")
```

**Solution**: Ensure auto-enrollment is disabled and use manual enrollment
```bash
# 1. Remove auto-enrolled agent from manager
sudo docker exec -it monitoring-manager /var/ossec/bin/manage_agents
# Choose (R)emove, enter agent ID with hostname

# 2. Stop agent and re-enroll with proper configuration
./monitoring-agent-control.sh stop
./monitoring-agent-control.sh enroll <MANAGER_IP>
# Enter the pre-configured client key with correct agent name

# 3. Verify enrollment configuration
grep -A5 "enrollment" etc/ossec.conf
# Should show: <enabled>no</enabled>
```

#### 2. **Enrollment Issues**

**Problem**: IP mismatch in client key
```bash
# Client key shows different IP than manager
001 agent 192.168.1.100 key...  # Key IP
Manager IP: 172.17.0.2           # Actual manager IP
```

**Solution**: Our enrollment automatically handles this
```bash
# Re-enroll with correct manager IP
./monitoring-agent-control.sh enroll 172.17.0.2
# Enter the same client key - IP will be corrected automatically
```

#### 2. **Connection Failed**

**Check manager accessibility:**
```bash
# Test port connectivity
nc -zv <MANAGER_IP> 1514

# Example with Docker manager
nc -zv 172.17.0.2 1514
```

**Check manager status:**
```bash
# Docker manager
sudo docker logs monitoring-manager
sudo docker exec -it monitoring-manager /var/ossec/bin/wazuh-control status

# Physical manager
sudo /var/ossec/bin/wazuh-control status
```

#### 3. **Agent Won't Start**

**Check logs:**
```bash
# Agent logs
./monitoring-agent-control.sh logs 100

# Individual daemon logs
ls logs/
cat logs/monitoring-*.log
```

**Check permissions:**
```bash
# Fix permissions
./monitoring-agent-control.sh setup
chmod +x bin/*
```

**Check configuration:**
```bash
# Validate config
./monitoring-agent-control.sh health
```

#### 4. **Docker Manager Issues**

**Manager not accessible:**
```bash
# Check if container is running
sudo docker ps | grep wazuh

# Check container IP
sudo docker inspect monitoring-manager | grep IPAddress

# Check port mapping
sudo docker port monitoring-manager

# Restart container
sudo docker restart monitoring-manager
```

### Debug Mode

```bash
# Enable debug logging
./monitoring-agent-control.sh -d status
./monitoring-agent-control.sh -d start
```

### Log Files

```bash
# Main agent log
tail -f logs/monitoring-agent.log

# Individual daemon logs
tail -f logs/monitoring-agentd.log
tail -f logs/monitoring-modulesd.log
tail -f logs/monitoring-logcollector.log
```

---

## Windows Agent Support

### Windows Installation

The Windows Monitoring Agent provides the same professional functionality as the Linux version with full Windows integration.

#### Method 1: Download and Extract (Recommended)

```powershell
# Download and extract (PowerShell)
Invoke-WebRequest -Uri "https://releases.monitoring-solutions.com/monitoring-agent-windows.zip" -OutFile "monitoring-agent.zip"
Expand-Archive -Path "monitoring-agent.zip" -DestinationPath "C:\monitoring-agent"
cd C:\monitoring-agent

# Verify extraction
Get-ChildItem
```

#### Method 2: Manual Extraction

1. Download `monitoring-agent-windows.zip`
2. Extract to `C:\monitoring-agent` (or your preferred location)
3. Open PowerShell as Administrator
4. Navigate to the agent directory

**Important**: Always run PowerShell as Administrator for full functionality.

### Windows Requirements

- **OS**: Windows Server 2016+, Windows 10+ (64-bit)
- **PowerShell**: Version 5.1 or higher (included with Windows)
- **Memory**: 1GB RAM minimum, 2GB+ recommended
- **Storage**: 2GB free space minimum, 5GB+ recommended
- **Network**: Outbound TCP port 1514 to manager
- **Privileges**: Administrator rights required

### Windows Directory Structure

```
C:\monitoring-agent\
‚îú‚îÄ‚îÄ monitoring-agent-control.ps1    # Main control script
‚îú‚îÄ‚îÄ windows\                         # Windows-specific files
‚îÇ   ‚îú‚îÄ‚îÄ bin\                        # Windows binaries
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WAZUH_AGENT.EXE        # Main agent process
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AGENT_AUTH.EXE         # Authentication tool
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MANAGE_AGENTS.EXE      # Agent management
‚îÇ   ‚îú‚îÄ‚îÄ lib\                       # Libraries and DLLs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bypass.dll             # Windows bypass library
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ *.dll                  # Other required libraries
‚îÇ   ‚îú‚îÄ‚îÄ etc\                       # Configuration files
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ossec.conf             # Main configuration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ client.keys            # Authentication keys
‚îÇ   ‚îî‚îÄ‚îÄ logs\                      # Log files
‚îú‚îÄ‚îÄ scripts\windows\                # Windows support scripts
‚îÇ   ‚îú‚îÄ‚îÄ monitoring-watchdog.ps1    # Watchdog process
‚îÇ   ‚îú‚îÄ‚îÄ monitoring-boot-recovery.ps1 # Boot recovery
‚îÇ   ‚îî‚îÄ‚îÄ monitoring-logging.ps1     # Logging system
‚îî‚îÄ‚îÄ docs\                          # Documentation
```

### Windows Agent Features

#### ‚úÖ **Windows Service Integration**
- Automatic installation as Windows Service
- Auto-startup on system boot
- Service recovery on failure
- Task Scheduler backup for reliability

#### ‚úÖ **Windows-Specific Bypass**
- Native DLL injection bypass for Windows
- Handles Windows user/group restrictions
- Administrator privilege management
- Windows registry and file system integration

#### ‚úÖ **PowerShell Native**
- Full PowerShell implementation
- Windows PowerShell 5.1+ compatible
- PowerShell Core 6+ compatible
- Cross-platform PowerShell support

#### ‚úÖ **Windows Event Integration**
- Windows Event Log monitoring
- Power event handling (shutdown/startup)
- WMI (Windows Management Instrumentation) integration
- Windows Performance Counters

### Windows Enrollment Process

The Windows agent uses **identical enrollment process** as Linux:

```powershell
# Interactive enrollment
.\monitoring-agent-control.ps1 enroll <MANAGER_IP>

# Example with Docker manager
.\monitoring-agent-control.ps1 enroll 172.17.0.2
```

**Interactive Process (Same as Linux):**
```
====================================================
Client Key Required
====================================================
Please provide the client key obtained from the Monitoring manager.
You can get this key by running on the manager:
  sudo /var/ossec/bin/manage_agents -l

The key should be in format:
  001 agent-name 192.168.1.100 abc123...def456

Enter the complete client key line: _
```

**Key Benefits (Same as Linux):**
- üö´ **No Auto-Enrollment**: Prevents automatic registration with Windows hostname
- üè∑Ô∏è **Manual Agent Names**: Uses descriptive names configured on manager
- üîê **Key-Based Only**: Only accepts pre-configured authentication keys
- ‚öôÔ∏è **Auto-Configuration**: Updates `ossec.conf` and `client.keys` automatically

### Windows Agent Management

#### Essential Commands

```powershell
# Check status
.\monitoring-agent-control.ps1 status

# Start agent (with auto-setup)
.\monitoring-agent-control.ps1 start

# Stop agent
.\monitoring-agent-control.ps1 stop

# Restart agent
.\monitoring-agent-control.ps1 restart

# View logs
.\monitoring-agent-control.ps1 logs 50        # Last 50 lines
.\monitoring-agent-control.ps1 logs 100 $true # Follow mode

# Health check
.\monitoring-agent-control.ps1 health

# Test connectivity
.\monitoring-agent-control.ps1 test-connection

# Show help
.\monitoring-agent-control.ps1 -Help
```

#### Windows Service Integration

The Windows agent automatically configures as a Windows Service:

```powershell
# Check service status
Get-Service -Name "MonitoringAgent"

# Service operations (alternative to PowerShell script)
Start-Service -Name "MonitoringAgent"
Stop-Service -Name "MonitoringAgent"
Restart-Service -Name "MonitoringAgent"

# Check service startup type
Get-WmiObject -Class Win32_Service -Filter "Name='MonitoringAgent'" | Select-Object StartMode

# View service logs
Get-EventLog -LogName Application -Source "MonitoringAgent" -Newest 50
```

### Windows Configuration

#### Configuration Files (Same Locations as Linux)

- **Main Config**: `windows\etc\ossec.conf`
- **Client Keys**: `windows\etc\client.keys`  
- **Logs**: `windows\logs\`

#### Key Windows-Specific Settings

```xml
<!-- Windows-specific ossec.conf settings -->
<ossec_config>
  <client>
    <server>
      <address>MANAGER_IP</address>
      <port>1514</port>
      <protocol>tcp</protocol>
    </server>
    <enrollment>
      <enabled>no</enabled>
    </enrollment>
  </client>
  
  <!-- Windows Event Log monitoring -->
  <localfile>
    <location>System</location>
    <log_format>eventlog</log_format>
  </localfile>
  
  <localfile>
    <location>Security</location>
    <log_format>eventlog</log_format>
  </localfile>
  
  <!-- Windows registry monitoring -->
  <windows_registry>
    <registry>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</registry>
  </windows_registry>
</ossec_config>
```

### Windows Troubleshooting

#### 1. **PowerShell Execution Policy Issues**

**Problem**: Script cannot run due to execution policy
```powershell
# Error: "cannot be loaded because running scripts is disabled on this system"
```

**Solution**: Use bypass execution policy (recommended for monitoring agent)
```powershell
# Temporary bypass (session only)
powershell -ExecutionPolicy Bypass -File ".\monitoring-agent-control.ps1" -Help

# Set for current user (persistent)
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# Check current policy
Get-ExecutionPolicy -List
```

**Note**: Using `-ExecutionPolicy Bypass` is **safe and recommended** for the monitoring agent script as it's a signed, trusted script.

#### 2. **Administrator Privileges**

**Problem**: Access denied errors
```powershell
# Error: "Access to the path is denied"
```

**Solution**: Run PowerShell as Administrator
```powershell
# Right-click PowerShell ‚Üí "Run as Administrator"
# Or use elevated shortcut
Start-Process powershell -Verb RunAs
```

#### 3. **Windows Service Issues**

**Problem**: Service won't start or install
```powershell
# Check service status
Get-Service -Name "MonitoringAgent" -ErrorAction SilentlyContinue

# If service missing, agent will auto-create it
.\monitoring-agent-control.ps1 start

# Manual service removal (if needed)
sc.exe delete "MonitoringAgent"
```

#### 4. **Windows Firewall Issues**

**Problem**: Cannot connect to manager
```powershell
# Test connectivity
Test-NetConnection -ComputerName <MANAGER_IP> -Port 1514

# Configure Windows Firewall automatically
.\monitoring-agent-control.ps1 configure-firewall <MANAGER_IP>

# Manual firewall rule
New-NetFirewallRule -DisplayName "Monitoring Agent" -Direction Outbound -Protocol TCP -RemotePort 1514 -Action Allow
```

#### 5. **Windows Binary Issues**

**Problem**: WAZUH_AGENT.EXE won't start
```powershell
# Check if binaries exist
Test-Path ".\windows\bin\WAZUH_AGENT.EXE"

# Check binary version/info
Get-ItemProperty ".\windows\bin\WAZUH_AGENT.EXE" | Select-Object VersionInfo

# Run binary test
.\monitoring-agent-control.ps1 health
```

#### 6. **Windows Event Log Issues**

**Problem**: Cannot write to Windows Event Log
```powershell
# Check if event source exists
[System.Diagnostics.EventLog]::SourceExists("MonitoringAgent")

# Manually create event source (as Administrator)
New-EventLog -LogName Application -Source "MonitoringAgent"
```

### Windows Advanced Configuration

#### Custom Service Configuration

```powershell
# View service configuration
sc.exe qc "MonitoringAgent"

# Change service startup type
sc.exe config "MonitoringAgent" start= auto

# Configure service recovery
sc.exe failure "MonitoringAgent" reset= 86400 actions= restart/5000/restart/10000/restart/30000
```

#### Task Scheduler Integration

```powershell
# View monitoring agent scheduled tasks
Get-ScheduledTask -TaskPath "\\" | Where-Object {$_.TaskName -like "*MonitoringAgent*"}

# Enable/disable task scheduler fallback
Disable-ScheduledTask -TaskName "MonitoringAgentStartup"
Enable-ScheduledTask -TaskName "MonitoringAgentStartup"
```

#### Registry Monitoring

```powershell
# Check registry monitoring configuration
Get-Content ".\windows\etc\ossec.conf" | Select-String "windows_registry" -A 5

# Test registry access
Test-Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
```

### Windows vs Linux Comparison

| Feature | Windows | Linux | Notes |
|---------|---------|-------|-------|
| **Installation** | Extract ZIP | Extract TAR.GZ | Same simplicity |
| **Enrollment** | Identical | Identical | Same interactive process |
| **Auto-Startup** | Windows Service | systemd service | Both automatic |
| **Bypass** | bypass.dll | bypass.so | Platform-specific |
| **Process Management** | Single WAZUH_AGENT.EXE | Multiple daemons | Windows unified |
| **Logs** | Event Log + Files | Files only | Windows enhanced |
| **Configuration** | ossec.conf | ossec.conf | Same format |
| **Firewall** | Windows Firewall | iptables/ufw | Auto-configured |
| **Recovery** | Task Scheduler | cron/systemd | Both automatic |

### Windows Security Considerations

#### 1. **Administrator Rights**
- Required for service installation and management
- Bypass DLL requires elevated privileges
- Configuration file access needs admin rights

#### 2. **Windows Defender/Antivirus**
- Add monitoring agent directory to exclusions
- Whitelist WAZUH_AGENT.EXE and bypass.dll
- Exclude log directories from real-time scanning

```powershell
# Add Windows Defender exclusions
Add-MpPreference -ExclusionPath "C:\monitoring-agent"
Add-MpPreference -ExclusionProcess "WAZUH_AGENT.EXE"
```

#### 3. **User Account Control (UAC)**
- Script automatically requests elevation
- No manual UAC bypass needed
- Transparent privilege escalation

### Windows Performance Optimization

#### Memory Usage
```powershell
# Monitor agent memory usage
Get-Process -Name "WAZUH_AGENT" | Select-Object Name,WorkingSet,CPU

# Adjust Windows performance settings if needed
# Control Panel ‚Üí System ‚Üí Advanced ‚Üí Performance Settings
```

#### Disk I/O
```powershell
# Monitor log file growth
Get-ChildItem ".\windows\logs\" | Select-Object Name,Length,LastWriteTime

# Configure log rotation (automatic)
.\monitoring-agent-control.ps1 logs 100  # View recent logs
```

### Windows Quick Reference

| Task | Command |
|------|---------|
| **Install** | Extract ZIP, run as Admin |
| **Enroll** | `.\monitoring-agent-control.ps1 enroll <IP>` |
| **Start** | `.\monitoring-agent-control.ps1 start` |
| **Stop** | `.\monitoring-agent-control.ps1 stop` |
| **Status** | `.\monitoring-agent-control.ps1 status` |
| **Logs** | `.\monitoring-agent-control.ps1 logs 50` |
| **Health** | `.\monitoring-agent-control.ps1 health` |
| **Service** | `Get-Service MonitoringAgent` |
| **Firewall** | `.\monitoring-agent-control.ps1 configure-firewall <IP>` |
| **Help** | `.\monitoring-agent-control.ps1 -Help` |

---

## Advanced Configuration

### File Structure

```
monitoring-agent/
‚îú‚îÄ‚îÄ monitoring-agent-control.sh     # Main control script
‚îú‚îÄ‚îÄ .setup_complete                 # Setup marker
‚îú‚îÄ‚îÄ bin/                            # Agent binaries
‚îÇ   ‚îú‚îÄ‚îÄ monitoring-agentd          # Main agent daemon
‚îÇ   ‚îú‚îÄ‚îÄ monitoring-modulesd        # Module manager
‚îÇ   ‚îú‚îÄ‚îÄ monitoring-logcollector    # Log collector
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ etc/
‚îÇ   ‚îú‚îÄ‚îÄ ossec.conf                 # Main configuration
‚îÇ   ‚îú‚îÄ‚îÄ client.keys               # Agent authentication
‚îÇ   ‚îî‚îÄ‚îÄ ossec.conf.backup.*       # Auto-backups
‚îú‚îÄ‚îÄ logs/                          # Log files
‚îú‚îÄ‚îÄ var/                           # Runtime data
‚îÇ   ‚îú‚îÄ‚îÄ run/                      # PID files
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ docs/                          # Documentation
```

### Environment Variables

```bash
# Wazuh compatibility
export WAZUH_HOME="/path/to/monitoring-agent"
export OSSEC_HOME="/path/to/monitoring-agent"

# Debug mode
export DEBUG=1
```

### Systemd Service (Optional)

```bash
# For system-wide installation (requires root)
sudo ./monitoring-agent-control.sh setup

# Enable service
sudo systemctl enable monitoring-agent
sudo systemctl start monitoring-agent
```

### Firewall Configuration

```bash
# Automatic firewall setup
./monitoring-agent-control.sh configure-firewall <MANAGER_IP> [PORT]

# Manual iptables rule
sudo iptables -A OUTPUT -p tcp -d <MANAGER_IP> --dport 1514 -j ACCEPT

# Manual UFW rule
sudo ufw allow out 1514/tcp
```

---

## Support and Documentation

### Getting Help

```bash
# Show all commands
./monitoring-agent-control.sh --help

# Version information
./monitoring-agent-control.sh --version

# Health check
./monitoring-agent-control.sh health
```

### Resources

- **Documentation**: See `docs/` directory
- **Logs**: Check `logs/` directory for troubleshooting
- **Backups**: Stored in `backup/` directory
- **Support**: support@monitoring-solutions.com

### Quick Reference

| Command | Description |
|---------|-------------|
| `enroll <ip>` | Interactive enrollment |
| `start` | Start agent (auto-setup) |
| `stop` | Stop agent |
| `status` | Show status |
| `test-connection` | Test manager connectivity |
| `logs [n]` | Show logs |
| `health` | Health check |
| `backup` | Backup config |

---

*Last updated: September 15, 2025*  
*Version: 1.0.0*  
*Copyright ¬© 2025 Monitoring Solutions Inc.*